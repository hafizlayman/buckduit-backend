services:
  # ==========================
  # üß† MAIN WEB SERVICE
  # ==========================
  - type: web
    name: buckduit-ai-core
    env: python
    region: singapore
    buildCommand: pip install -r requirements.txt
    startCommand: gunicorn -b 0.0.0.0:8080 app:app
    healthCheckPath: /
    plan: free
    autoDeploy: true

    envVars:
      - key: SUPABASE_URL
        value: https://lpdrdtjtowfhxujenewm.supabase.co
      - key: SUPABASE_SERVICE_KEY
        sync: false
      - key: TELEGRAM_BOT_TOKEN
        sync: false
      - key: TELEGRAM_CHAT_ID
        sync: false
      - key: PORT
        value: 8080
      - key: FLASK_ENV
        value: production

    scaling:
      minInstances: 1
      maxInstances: 1

    disk:
      name: cache
      mountPath: /data
      sizeGB: 1

    alerts:
      - rule: deploy-failed
        threshold: 1
        action: notify
      - rule: restart-failed
        threshold: 1
        action: notify

  # ==========================
  # ‚öôÔ∏è BACKGROUND WORKER
  # ==========================
  - type: worker
    name: buckduit-ai-core-worker
    env: python
    region: singapore
    buildCommand: pip install -r requirements.txt
    startCommand: python buckduit_ai_core.py
    plan: free
    autoDeploy: true

    envVars:
      - key: SUPABASE_URL
        value: https://lpdrdtjtowfhxujenewm.supabase.co
      - key: SUPABASE_SERVICE_KEY
        sync: false
      - key: TELEGRAM_BOT_TOKEN
        sync: false
      - key: TELEGRAM_CHAT_ID
        sync: false
      - key: FLASK_ENV
        value: production

    scaling:
      minInstances: 1
      maxInstances: 1

  # ==========================
  # üîÅ AUTO-HEAL CRON (30 min)
  # ==========================
  - type: cron
    name: auto-restart-ai-core
    env: python
    schedule: "*/30 * * * *"
    buildCommand: ""
    startCommand: |
      echo "Restarting buckduit-ai-core via Render cron job..."
      curl -X POST https://api.render.com/v1/services/$RENDER_SERVICE_ID/redeploy \
        -H "Authorization: Bearer $RENDER_API_KEY"
    plan: free
